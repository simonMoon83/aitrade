{% extends "base.html" %}

{% block title %}AI íŠ¸ë ˆì´ë” - AI ì‹ í˜¸{% endblock %}

{% block content %}
<div class="card">
    <div class="header-actions"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
        <h3>ğŸ¯ AI ë§¤ë§¤ ì‹ í˜¸ ì´ë ¥</h3>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-group">
            <label for="filter-date-from">ì‹œì‘ ë‚ ì§œ</label>
            <input type="date" id="filter-date-from">
        </div>
        <div class="filter-group">
            <label for="filter-date-to">ì¢…ë£Œ ë‚ ì§œ</label>
            <input type="date" id="filter-date-to">
        </div>
        <div class="filter-group">
            <label for="filter-symbol">ì¢…ëª©</label>
            <input type="text" id="filter-symbol" placeholder="ì˜ˆ: AAPL">
        </div>
        <div class="filter-group">
            <label for="filter-signal-type">ì‹ í˜¸ ìœ í˜•</label>
            <select id="filter-signal-type">
                <option value="all">ì „ì²´</option>
                <option value="buy">ë§¤ìˆ˜ ì‹ í˜¸</option>
                <option value="sell">ë§¤ë„ ì‹ í˜¸</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-confidence">ìµœì†Œ ì‹ ë¢°ë„ (%)</label>
            <input type="number" id="filter-confidence" min="0" max="100" value="0" placeholder="0-100">
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" onclick="applyFilters()">ì ìš©</button>
            <button class="btn btn-warning" onclick="resetFilters()">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div class="table-container">
        <table class="table" id="signals-table">
            <thead>
                <tr>
                    <th>ì‹œê°„</th>
                    <th>ì¢…ëª©</th>
                    <th>ì‹ í˜¸</th>
                    <th>ì‹ ë¢°ë„</th>
                    <th>í˜„ì¬ê°€</th>
                    <th>ëª©í‘œê°€</th>
                    <th>ì†ì ˆê°€</th>
                    <th>ì´ìœ </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="8" style="text-align:center; padding: 2rem; color:#999;">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allSignals = [];

    function loadSignals() {
        fetch('/api/signals')
            .then(response => response.json())
            .then(data => {
                allSignals = data.signals || data;
                displaySignals(allSignals);
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelector('#signals-table tbody').innerHTML =
                    '<tr><td colspan="8" style="text-align:center; color:red;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            });
    }

    function displaySignals(signals) {
        const tbody = document.querySelector('#signals-table tbody');
        tbody.innerHTML = '';

        if (!signals || signals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 2rem; color:#999;">ìƒì„±ëœ ì‹ í˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        signals.forEach(signal => {
            const row = tbody.insertRow();
            const isBuy = signal.signal === 'buy';
            const confidence = (signal.confidence * 100).toFixed(1);

            row.innerHTML = `
                <td data-label="ì‹œê°„" style="color:#64748b;">${new Date(signal.timestamp).toLocaleString()}</td>
                <td data-label="ì¢…ëª©" style="font-weight:600;">${signal.symbol}</td>
                <td data-label="ì‹ í˜¸"><span class="badge ${isBuy ? 'badge-success' : 'badge-danger'}">${signal.signal.toUpperCase()}</span></td>
                <td data-label="ì‹ ë¢°ë„">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <div style="width:50px; height:4px; background:#e2e8f0; border-radius:2px;">
                            <div style="width:${confidence}%; height:100%; background:${isBuy ? '#27ae60' : '#e74c3c'}; border-radius:2px;"></div>
                        </div>
                        <span style="font-size:0.85rem;">${confidence}%</span>
                    </div>
                </td>
                <td data-label="í˜„ì¬ê°€">$${signal.current_price.toFixed(2)}</td>
                <td data-label="ëª©í‘œê°€">$${signal.target_price ? signal.target_price.toFixed(2) : '-'}</td>
                <td data-label="ì†ì ˆê°€">$${signal.stop_loss ? signal.stop_loss.toFixed(2) : '-'}</td>
                <td data-label="ì´ìœ " style="max-width:300px; font-size:0.9rem; color:#475569;">${signal.reason}</td>
            `;
        });
    }

    function applyFilters() {
        const dateFrom = document.getElementById('filter-date-from').value;
        const dateTo = document.getElementById('filter-date-to').value;
        const symbol = document.getElementById('filter-symbol').value.toUpperCase();
        const signalType = document.getElementById('filter-signal-type').value;
        const minConfidence = parseFloat(document.getElementById('filter-confidence').value) / 100;

        let filtered = allSignals.filter(signal => {
            const signalDate = new Date(signal.timestamp).toISOString().split('T')[0];

            if (dateFrom && signalDate < dateFrom) return false;
            if (dateTo && signalDate > dateTo) return false;
            if (symbol && !signal.symbol.toUpperCase().includes(symbol)) return false;
            if (signalType !== 'all' && signal.signal !== signalType) return false;
            if (signal.confidence < minConfidence) return false;

            return true;
        });

        displaySignals(filtered);
    }

    function resetFilters() {
        document.getElementById('filter-date-from').value = '';
        document.getElementById('filter-date-to').value = '';
        document.getElementById('filter-symbol').value = '';
        document.getElementById('filter-signal-type').value = 'all';
        document.getElementById('filter-confidence').value = '0';
        displaySignals(allSignals);
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadSignals();
    });
</script>
{% endblock %}