{% extends "base.html" %}

{% block title %}AI íŠ¸ë ˆì´ë” - ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .metric:last-child {
        border-bottom: none;
    }

    .metric-label {
        color: #64748b;
        font-weight: 500;
    }

    .metric-value {
        font-weight: 700;
        font-size: 1.1rem;
        color: #334155;
    }

    .control-panel {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }

    .control-group {
        display: flex;
        gap: 0.75rem;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-running {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    .status-stopped {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    @media (max-width: 768px) {
        .control-panel {
            flex-direction: column;
            align-items: stretch;
        }

        .control-group {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Control Panel -->
<div class="control-panel">
    <div class="control-group">
        <button class="btn btn-success" onclick="controlTrader('start')">â–¶ ê±°ë˜ ì‹œì‘</button>
        <button class="btn btn-danger" onclick="controlTrader('stop')">â¹ ê±°ë˜ ì¤‘ì§€</button>
        <button class="btn btn-warning" onclick="controlTrader('emergency_stop')">ğŸš¨ ê¸´ê¸‰ ì •ì§€</button>
    </div>
    <div class="control-group">
        <div id="status" class="status-badge status-stopped">
            <span class="status-icon">â—</span> ìƒíƒœ: ì¤‘ì§€ë¨
        </div>
        <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Portfolio Card -->
    <div class="card">
        <h3>ğŸ’° í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©</h3>
        <div id="portfolio-info">
            <div class="metric">
                <span class="metric-label">ì´ ê°€ì¹˜</span>
                <span class="metric-value" id="portfolio-value">$0</span>
            </div>
            <div class="metric">
                <span class="metric-label">í˜„ê¸ˆ</span>
                <span class="metric-value" id="cash">$0</span>
            </div>
            <div class="metric">
                <span class="metric-label">ì´ ìˆ˜ìµë¥ </span>
                <span class="metric-value" id="total-return">0%</span>
            </div>
            <div class="metric">
                <span class="metric-label">ë³´ìœ  í¬ì§€ì…˜</span>
                <span class="metric-value" id="num-positions">0ê°œ</span>
            </div>
        </div>
    </div>

    <!-- Trading Status Card -->
    <div class="card">
        <h3>ğŸ“Š ê±°ë˜ í˜„í™©</h3>
        <div id="trading-info">
            <div class="metric">
                <span class="metric-label">ì¼ì¼ ê±°ë˜ëŸ‰</span>
                <span class="metric-value" id="daily-trades">0íšŒ</span>
            </div>
            <div class="metric">
                <span class="metric-label">ì‹œìŠ¤í…œ ìƒíƒœ</span>
                <span class="metric-value" id="trading-status">ì¤‘ì§€</span>
            </div>
            <div class="metric">
                <span class="metric-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</span>
                <span class="metric-value" id="last-update">-</span>
            </div>
        </div>
    </div>

    <!-- Positions Card -->
    <div class="card" style="grid-column: 1 / -1;">
        <h3>ğŸ’¼ ë³´ìœ  í¬ì§€ì…˜</h3>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>ì¢…ëª©</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>í‰ê· ê°€</th>
                        <th>í˜„ì¬ê°€</th>
                        <th>í‰ê°€ì†ìµ</th>
                        <th>ìˆ˜ìµë¥ </th>
                    </tr>
                </thead>
                <tbody id="positions-tbody">
                    <tr>
                        <td colspan="6" style="text-align:center; color:#999;">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Trades Card -->
    <div class="card" style="grid-column: 1 / -1;">
        <h3>ğŸ•’ ìµœê·¼ ê±°ë˜ ë‚´ì—­</h3>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>ì‹œê°„</th>
                        <th>ì¢…ëª©</th>
                        <th>ìœ í˜•</th>
                        <th>ìˆ˜ëŸ‰</th>
                        <th>ê°€ê²©</th>
                        <th>ì‹¤í˜„ì†ìµ</th>
                    </tr>
                </thead>
                <tbody id="trades-tbody">
                    <tr>
                        <td colspan="6" style="text-align:center; color:#999;">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Performance Chart -->
<div class="card">
    <h3>ğŸ“ˆ ì„±ê³¼ ì°¨íŠ¸ (ìµœê·¼ 30ì¼)</h3>
    <div style="height: 400px; position: relative;">
        <canvas id="performanceChart"></canvas>
    </div>
</div>

<!-- Export -->
<div class="card">
    <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
    <button class="btn btn-success" onclick="exportTrades()">ğŸ“¥ ê±°ë˜ ë‚´ì—­ CSV ë‹¤ìš´ë¡œë“œ</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let refreshInterval;
    let performanceChart = null;

    function controlTrader(action) {
        fetch('/api/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Control response:', data);
                refreshData();
                // Show toast or alert could be added here
            })
            .catch(error => console.error('Control error:', error));
    }

    function refreshData() {
        const now = new Date().toLocaleTimeString();
        document.getElementById('last-update').textContent = now;

        // Portfolio
        fetch('/api/portfolio')
            .then(res => res.json())
            .then(data => updatePortfolioInfo(data))
            .catch(err => console.error('Portfolio error:', err));

        // Trades
        fetch('/api/trades')
            .then(res => res.json())
            .then(data => updateTradesTable(data.trades || data))
            .catch(err => console.error('Trades error:', err));

        // Performance Info
        fetch('/api/performance')
            .then(res => res.json())
            .then(data => updatePerformanceInfo(data))
            .catch(err => console.error('Performance error:', err));

        // Chart
        fetch('/api/performance/chart?days=30')
            .then(res => res.json())
            .then(data => updatePerformanceChart(data))
            .catch(err => console.error('Chart error:', err));
    }

    function exportTrades() {
        window.location.href = '/api/export/trades';
    }

    function updatePortfolioInfo(data) {
        document.getElementById('portfolio-value').textContent = '$' + (data.portfolio_value || 0).toLocaleString();
        document.getElementById('cash').textContent = '$' + (data.cash || 0).toLocaleString();

        const totalReturn = (data.total_return || 0) * 100;
        const returnEl = document.getElementById('total-return');
        returnEl.textContent = totalReturn.toFixed(2) + '%';
        returnEl.className = 'metric-value ' + (totalReturn >= 0 ? 'text-success' : 'text-danger');

        document.getElementById('num-positions').textContent = Object.keys(data.positions || {}).length + 'ê°œ';
        updatePositionsTable(data.positions || {});
    }

    function updatePositionsTable(positions) {
        const tbody = document.getElementById('positions-tbody');
        tbody.innerHTML = '';

        if (Object.keys(positions).length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem; color:#94a3b8;">ë³´ìœ  ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        for (const [symbol, pos] of Object.entries(positions)) {
            const row = tbody.insertRow();
            const pnl = pos.unrealized_pnl || 0;
            const pnlPercent = (pos.current_price - pos.avg_price) / pos.avg_price * 100;

            row.innerHTML = `
                <td style="font-weight:600;">${symbol}</td>
                <td>${pos.quantity}</td>
                <td>$${pos.avg_price.toFixed(2)}</td>
                <td>$${pos.current_price.toFixed(2)}</td>
                <td class="${pnl >= 0 ? 'text-success' : 'text-danger'}">$${pnl.toFixed(2)}</td>
                <td class="${pnlPercent >= 0 ? 'text-success' : 'text-danger'}">${pnlPercent.toFixed(2)}%</td>
            `;
        }
    }

    function updateTradesTable(trades) {
        const tbody = document.getElementById('trades-tbody');
        tbody.innerHTML = '';

        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem; color:#94a3b8;">ìµœê·¼ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        // Sort by timestamp desc if not already
        // trades.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        trades.slice(0, 10).forEach(trade => {
            const row = tbody.insertRow();
            const pnl = trade.pnl || 0;
            const isBuy = trade.order_type === 'buy';

            row.innerHTML = `
                <td style="color:#64748b; font-size:0.9rem;">${new Date(trade.timestamp).toLocaleString()}</td>
                <td style="font-weight:600;">${trade.symbol}</td>
                <td><span class="badge ${isBuy ? 'badge-success' : 'badge-danger'}">${trade.order_type.toUpperCase()}</span></td>
                <td>${trade.quantity}</td>
                <td>$${trade.price.toFixed(2)}</td>
                <td class="${pnl >= 0 ? 'text-success' : 'text-danger'}">${pnl ? '$' + pnl.toFixed(2) : '-'}</td>
            `;
        });
    }

    function updatePerformanceInfo(data) {
        document.getElementById('daily-trades').textContent = (data.daily_trades || 0) + 'íšŒ';
        document.getElementById('trading-status').textContent = data.is_running ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€ë¨';

        const statusEl = document.getElementById('status');
        if (data.is_running) {
            statusEl.className = 'status-badge status-running';
            statusEl.innerHTML = '<span class="status-icon">â—</span> ìƒíƒœ: ì‹¤í–‰ ì¤‘';
        } else {
            statusEl.className = 'status-badge status-stopped';
            statusEl.innerHTML = '<span class="status-icon">â—</span> ìƒíƒœ: ì¤‘ì§€ë¨';
        }
    }

    function updatePerformanceChart(data) {
        const ctx = document.getElementById('performanceChart');
        if (!ctx) return;

        if (performanceChart) performanceChart.destroy();

        if (!data.labels || data.labels.length === 0) return;

        performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜ ($)',
                    data: data.portfolio_values,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#333',
                        bodyColor: '#666',
                        borderColor: '#e1e4e8',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function (context) {
                                return 'ê°€ì¹˜: $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 8 } },
                    y: {
                        border: { display: false },
                        grid: { color: '#f1f5f9' },
                        ticks: { callback: value => '$' + value.toLocaleString() }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        refreshData();
        refreshInterval = setInterval(refreshData, 30000);
    });

    window.addEventListener('beforeunload', function () {
        if (refreshInterval) clearInterval(refreshInterval);
    });
</script>
{% endblock %}