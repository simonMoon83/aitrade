{% extends "base.html" %}

{% block title %}AI íŠ¸ë ˆì´ë” - ì¼ì¼ ë ˆí¬íŠ¸{% endblock %}

{% block extra_css %}
<style>
    .table tr {
        cursor: pointer;
        transition: background 0.2s;
    }

    .table tr:hover {
        background: #f8fafc;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 2rem;
        border: 1px solid #888;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h3>ğŸ“‹ ì¼ì¼ ì„±ê³¼ ë ˆí¬íŠ¸</h3>
    <div class="action-bar" style="margin-bottom: 1rem; display: flex; justify-content: flex-end;">
        <button class="btn btn-primary" onclick="generateReport()" id="generate-btn" style="white-space: nowrap;">
            <span>âœ¨</span>
            <span>ìƒˆ ë ˆí¬íŠ¸ ìƒì„±</span>
        </button>
    </div>
    <div class="table-container">
        <table class="table" id="reports-table">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ì´ ê±°ë˜ìˆ˜</th>
                    <th>ìŠ¹ë¥ </th>
                    <th>ìˆ˜ìµê¸ˆ</th>
                    <th>ìˆ˜ìµë¥ </th>
                    <th>ìµœëŒ€ ë‚™í­ (MDD)</th>
                    <th>ìƒ¤í”„ ì§€ìˆ˜</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="7" style="text-align:center; padding: 2rem; color:#999;">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for Report Details -->
<div id="report-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ğŸ“Š ë ˆí¬íŠ¸ ìƒì„¸: <span id="report-date"></span></h2>
        <div id="report-details" style="margin-top: 1rem;">
            <p style="text-align:center; color:#999;">ë¡œë”© ì¤‘...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ë ˆí¬íŠ¸ ìƒì„± í•¨ìˆ˜
    function generateReport() {
        const btn = document.getElementById('generate-btn');
        const originalText = btn.textContent;

        btn.disabled = true;
        btn.textContent = 'ìƒì„± ì¤‘...';

        fetch('/api/reports/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ… ë ˆí¬íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    // ë ˆí¬íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    location.reload();
                } else {
                    alert('âŒ ë ˆí¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('âŒ ë ˆí¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = originalText;
            });
    }

    const modal = document.getElementById('report-modal');
    const closeBtn = document.getElementsByClassName('close')[0];

    closeBtn.onclick = function () {
        modal.style.display = 'none';
    }

    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    function showReportDetails(date) {
        // ë‚ ì§œ í˜•ì‹ì„ YYYYMMDDë¡œ ë³€í™˜
        let formattedDate = date;

        // ë‚ ì§œê°€ YYYY-MM-DD í˜•ì‹ì´ë©´ YYYYMMDDë¡œ ë³€í™˜
        if (date.includes('-')) {
            formattedDate = date.replace(/-/g, '');
        }
        // ë‚ ì§œê°€ YYYY/MM/DD í˜•ì‹ì´ë©´ YYYYMMDDë¡œ ë³€í™˜
        else if (date.includes('/')) {
            formattedDate = date.replace(/\//g, '');
        }

        document.getElementById('report-date').textContent = date;
        document.getElementById('report-details').innerHTML = '<p style="text-align:center; color:#999;">ë¡œë”© ì¤‘...</p>';
        modal.style.display = 'block';

        fetch(`/api/reports/${formattedDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('report-details').innerHTML = `<p style="color:red;">ì˜¤ë¥˜: ${data.error}</p>`;
                    return;
                }

                const report = data.report || data;
                let html = `
                    <div class="card" style="margin-bottom: 1rem;">
                        <h4>ğŸ“ˆ ì„±ê³¼ ìš”ì•½</h4>
                        <table class="table">
                            <tr><td><strong>ì´ ê±°ë˜ ìˆ˜:</strong></td><td>${report.total_trades || 0}íšŒ</td></tr>
                            <tr><td><strong>ìŠ¹ë¥ :</strong></td><td>${((report.win_rate || 0) * 100).toFixed(2)}%</td></tr>
                            <tr><td><strong>ìˆ˜ìµê¸ˆ:</strong></td><td class="${(report.profit || 0) >= 0 ? 'text-success' : 'text-danger'}">$${(report.profit || 0).toFixed(2)}</td></tr>
                            <tr><td><strong>ìˆ˜ìµë¥ :</strong></td><td>${((report.return_pct || 0) * 100).toFixed(2)}%</td></tr>
                            <tr><td><strong>ìµœëŒ€ ë‚™í­:</strong></td><td class="text-danger">${((report.mdd || 0) * 100).toFixed(2)}%</td></tr>
                            <tr><td><strong>ìƒ¤í”„ ì§€ìˆ˜:</strong></td><td>${(report.sharpe_ratio || 0).toFixed(3)}</td></tr>
                        </table>
                    </div>
                `;

                if (report.trades && report.trades.length > 0) {
                    html += `
                        <div class="card">
                            <h4>ğŸ’¼ ê±°ë˜ ë‚´ì—­</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ì‹œê°„</th>
                                        <th>ì¢…ëª©</th>
                                        <th>ìœ í˜•</th>
                                        <th>ìˆ˜ëŸ‰</th>
                                        <th>ê°€ê²©</th>
                                        <th>ì†ìµ</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    report.trades.forEach(trade => {
                        const isBuy = trade.order_type === 'buy';
                        const pnl = trade.pnl || 0;
                        const price = trade.price || 0;
                        const quantity = trade.quantity || 0;
                        const timestamp = trade.timestamp || new Date().toISOString();
                        html += `
                            <tr>
                                <td>${new Date(timestamp).toLocaleString()}</td>
                                <td>${trade.symbol || 'N/A'}</td>
                                <td><span class="badge ${isBuy ? 'badge-success' : 'badge-danger'}">${(trade.order_type || 'unknown').toUpperCase()}</span></td>
                                <td>${quantity}</td>
                                <td>$${price.toFixed(2)}</td>
                                <td class="${pnl >= 0 ? 'text-success' : 'text-danger'}">${pnl ? '$' + pnl.toFixed(2) : '-'}</td>
                            </tr>
                        `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                document.getElementById('report-details').innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('report-details').innerHTML = '<p style="color:red;">ë ˆí¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/reports/list')
            .then(response => response.json())
            .then(data => {
                const reports = data.reports || data;
                const tbody = document.querySelector('#reports-table tbody');
                tbody.innerHTML = '';

                if (!reports || reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 2rem; color:#999;">ìƒì„±ëœ ë ˆí¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                reports.forEach(report => {
                    const row = tbody.insertRow();
                    const profit = report.profit || 0;
                    const return_pct = (report.return_pct || 0) * 100;
                    const win_rate = (report.win_rate || 0) * 100;
                    const mdd = (report.mdd || 0) * 100;
                    const sharpe = report.sharpe_ratio || 0;
                    const total_trades = report.total_trades || 0;

                    row.style.cursor = 'pointer';
                    row.onclick = function () {
                        showReportDetails(report.date);
                    };

                    row.innerHTML = `
                        <td data-label="ë‚ ì§œ" style="font-weight:600;">${report.date || 'N/A'}</td>
                        <td data-label="ì´ ê±°ë˜ìˆ˜">${total_trades}íšŒ</td>
                        <td data-label="ìŠ¹ë¥ ">${win_rate.toFixed(1)}%</td>
                        <td data-label="ìˆ˜ìµê¸ˆ" class="${profit >= 0 ? 'text-success' : 'text-danger'}">$${profit.toFixed(2)}</td>
                        <td data-label="ìˆ˜ìµë¥ " class="${return_pct >= 0 ? 'text-success' : 'text-danger'}">${return_pct.toFixed(2)}%</td>
                        <td data-label="ìµœëŒ€ ë‚™í­" class="text-danger">-${mdd.toFixed(2)}%</td>
                        <td data-label="ìƒ¤í”„ ì§€ìˆ˜">${sharpe.toFixed(2)}</td>
                    `;
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelector('#reports-table tbody').innerHTML =
                    '<tr><td colspan="7" style="text-align:center; color:red;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            });
    });
</script>
{% endblock %}