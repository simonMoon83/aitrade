{% extends "base.html" %}

{% block title %}AI íŠ¸ë ˆì´ë” - ê±°ë˜ ì´ë ¥{% endblock %}

{% block content %}
<div class="card">
    <div class="header-actions"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
        <h3>ğŸ“ˆ ì „ì²´ ê±°ë˜ ì´ë ¥</h3>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-group">
            <label for="filter-date-from">ì‹œì‘ ë‚ ì§œ</label>
            <input type="date" id="filter-date-from">
        </div>
        <div class="filter-group">
            <label for="filter-date-to">ì¢…ë£Œ ë‚ ì§œ</label>
            <input type="date" id="filter-date-to">
        </div>
        <div class="filter-group">
            <label for="filter-symbol">ì¢…ëª©</label>
            <input type="text" id="filter-symbol" placeholder="ì˜ˆ: AAPL">
        </div>
        <div class="filter-group">
            <label for="filter-order-type">ì£¼ë¬¸ ìœ í˜•</label>
            <select id="filter-order-type">
                <option value="all">ì „ì²´</option>
                <option value="buy">ë§¤ìˆ˜</option>
                <option value="sell">ë§¤ë„</option>
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" onclick="applyFilters()">ì ìš©</button>
            <button class="btn btn-warning" onclick="resetFilters()">ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div class="table-container">
        <table class="table" id="history-table">
            <thead>
                <tr>
                    <th>ì‹œê°„</th>
                    <th>ì¢…ëª©</th>
                    <th>ìœ í˜•</th>
                    <th>ìˆ˜ëŸ‰</th>
                    <th>ê°€ê²©</th>
                    <th>ì´ì•¡</th>
                    <th>ì†ìµ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="7" style="text-align:center; padding: 2rem; color:#999;">ë°ì´í„° ë¡œë”© ì¤‘...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allTrades = [];

    function loadTrades() {
        fetch('/api/trades')
            .then(response => response.json())
            .then(data => {
                allTrades = data.trades || data;
                displayTrades(allTrades);
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelector('#history-table tbody').innerHTML =
                    '<tr><td colspan="7" style="text-align:center; color:red;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            });
    }

    function displayTrades(trades) {
        const tbody = document.querySelector('#history-table tbody');
        tbody.innerHTML = '';

        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 2rem; color:#999;">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        trades.forEach(trade => {
            const row = tbody.insertRow();
            const total = trade.price * trade.quantity;
            const pnl = trade.pnl || 0;
            const isBuy = trade.order_type === 'buy';

            row.innerHTML = `
                <td data-label="ì‹œê°„" style="color:#64748b;">${new Date(trade.timestamp).toLocaleString()}</td>
                <td data-label="ì¢…ëª©" style="font-weight:600;">${trade.symbol}</td>
                <td data-label="ìœ í˜•"><span class="badge ${isBuy ? 'badge-success' : 'badge-danger'}">${trade.order_type.toUpperCase()}</span></td>
                <td data-label="ìˆ˜ëŸ‰">${trade.quantity}</td>
                <td data-label="ê°€ê²©">$${trade.price.toFixed(2)}</td>
                <td data-label="ì´ì•¡">$${total.toFixed(2)}</td>
                <td data-label="ì†ìµ" class="${pnl >= 0 ? 'text-success' : 'text-danger'}">${pnl ? '$' + pnl.toFixed(2) : '-'}</td>
            `;
        });
    }

    function applyFilters() {
        const dateFrom = document.getElementById('filter-date-from').value;
        const dateTo = document.getElementById('filter-date-to').value;
        const symbol = document.getElementById('filter-symbol').value.toUpperCase();
        const orderType = document.getElementById('filter-order-type').value;

        let filtered = allTrades.filter(trade => {
            const tradeDate = new Date(trade.timestamp).toISOString().split('T')[0];

            if (dateFrom && tradeDate < dateFrom) return false;
            if (dateTo && tradeDate > dateTo) return false;
            if (symbol && !trade.symbol.toUpperCase().includes(symbol)) return false;
            if (orderType !== 'all' && trade.order_type !== orderType) return false;

            return true;
        });

        displayTrades(filtered);
    }

    function resetFilters() {
        document.getElementById('filter-date-from').value = '';
        document.getElementById('filter-date-to').value = '';
        document.getElementById('filter-symbol').value = '';
        document.getElementById('filter-order-type').value = 'all';
        displayTrades(allTrades);
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadTrades();
    });
</script>
{% endblock %}