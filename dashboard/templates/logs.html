{% extends "base.html" %}

{% block title %}AI íŠ¸ë ˆì´ë” - ì‹œìŠ¤í…œ ë¡œê·¸{% endblock %}

{% block extra_css %}
<style>
    .log-container {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1.5rem;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', monospace;
        height: 600px;
        overflow-y: auto;
        font-size: 0.9rem;
        line-height: 1.5;
        border: 1px solid #334155;
    }

    .log-entry {
        margin-bottom: 0.25rem;
        display: flex;
        gap: 1rem;
    }

    .level-INFO {
        color: #3b82f6;
    }

    .level-WARNING {
        color: #f59e0b;
    }

    .level-ERROR {
        color: #ef4444;
    }

    .level-DEBUG {
        color: #64748b;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“ ì‹œìŠ¤í…œ ë¡œê·¸</h3>
            <div class="btn-group" style="flex-wrap: wrap;">
                <button class="btn btn-info" onclick="refreshLogs()">
                    <span>ğŸ”„</span>
                    <span>ìƒˆë¡œê³ ì¹¨</span>
                </button>
                <button class="btn btn-danger" onclick="clearLogs()">
                    <span>ğŸ—‘ï¸</span>
                    <span>ë¡œê·¸ ì§€ìš°ê¸°</span>
                </button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="filter-log-type">ë¡œê·¸ ìœ í˜•</label>
                <select id="filter-log-type" onchange="refreshLogs()">
                    <option value="paper_trader">Paper Trader</option>
                    <option value="web_dashboard">Web Dashboard</option>
                    <option value="data_collector">Data Collector</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-log-level">ë¡œê·¸ ë ˆë²¨</label>
                <select id="filter-log-level" onchange="refreshLogs()">
                    <option value="ALL">ì „ì²´</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-limit">í‘œì‹œ ê°œìˆ˜</label>
                <select id="filter-limit" onchange="refreshLogs()">
                    <option value="50">50ê°œ</option>
                    <option value="100" selected>100ê°œ</option>
                    <option value="200">200ê°œ</option>
                    <option value="500">500ê°œ</option>
                </select>
            </div>
        </div>

        <div id="log-viewer" class="log-container">
            <div style="text-align:center; padding:2rem; color:#64748b;">ë¡œê·¸ ë¡œë”© ì¤‘...</div>
        </div>
    </div>
    {% endblock %}

    {% block extra_js %}
    <script>
        function refreshLogs() {
            const logType = document.getElementById('filter-log-type').value;
            const logLevel = document.getElementById('filter-log-level').value;
            const limit = document.getElementById('filter-limit').value;

            fetch(`/api/logs?type=${logType}&level=${logLevel}&limit=${limit}`)
                .then(response => response.json())
                .then(data => {
                    const logViewer = document.getElementById('log-viewer');
                    logViewer.innerHTML = '';

                    const logs = data.logs || data;

                    if (!logs || logs.length === 0) {
                        logViewer.innerHTML = '<div style="text-align:center; padding:2rem; color:#64748b;">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    logs.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'log-entry';

                        let levelClass = 'level-INFO';
                        let logContent = '';

                        if (typeof log === 'object') {
                            const level = log.level || 'INFO';
                            if (level === 'ERROR' || level === 'CRITICAL') levelClass = 'level-ERROR';
                            else if (level === 'WARNING') levelClass = 'level-WARNING';
                            else if (level === 'DEBUG') levelClass = 'level-DEBUG';

                            logContent = log.full || `[${log.timestamp}] [${level}] ${log.message}`;
                        } else {
                            logContent = log;
                            if (log.includes('ERROR') || log.includes('CRITICAL')) levelClass = 'level-ERROR';
                            else if (log.includes('WARNING')) levelClass = 'level-WARNING';
                            else if (log.includes('DEBUG')) levelClass = 'level-DEBUG';
                        }

                        div.innerHTML = `
                        <span class="${levelClass}">${logContent}</span>
                    `;
                        logViewer.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('log-viewer').innerHTML =
                        '<div style="text-align:center; padding:2rem; color:#ef4444;">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                });
        }

        function clearLogs() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            fetch('/api/logs/clear', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    refreshLogs();
                })
                .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function () {
            refreshLogs();
            // 5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
            setInterval(refreshLogs, 5000);
        });
    </script>
    {% endblock %}