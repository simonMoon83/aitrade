{% extends "base.html" %}

{% block title %}AI íŠ¸ë ˆì´ë” - ì‹œìŠ¤í…œ ë¡œê·¸{% endblock %}

{% block extra_css %}
<style>
    .log-container {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1.5rem;
        border-radius: 8px;
        font-family: 'Consolas', 'Monaco', monospace;
        height: 600px;
        overflow-y: auto;
        font-size: 0.9rem;
        line-height: 1.5;
        border: 1px solid #334155;
    }

    .log-entry {
        margin-bottom: 0.25rem;
        display: flex;
        gap: 1rem;
    }

    .log-time {
        color: #94a3b8;
        min-width: 150px;
    }

    .log-level {
        font-weight: bold;
        min-width: 60px;
    }

    .log-message {
        flex: 1;
        word-break: break-all;
    }

    .level-INFO {
        color: #3b82f6;
    }

    .level-WARNING {
        color: #f59e0b;
    }

    .level-ERROR {
        color: #ef4444;
    }

    .level-DEBUG {
        color: #64748b;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h3>ğŸ“ ì‹œìŠ¤í…œ ë¡œê·¸</h3>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="refreshLogs()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-danger" onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <div id="log-viewer" class="log-container">
        <div style="text-align:center; padding:2rem; color:#64748b;">ë¡œê·¸ ë¡œë”© ì¤‘...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function refreshLogs() {
        fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                const logViewer = document.getElementById('log-viewer');
                logViewer.innerHTML = '';

                const logs = data.logs || data;

                if (!logs || logs.length === 0) {
                    logViewer.innerHTML = '<div style="text-align:center; padding:2rem; color:#64748b;">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'log-entry';

                    let levelClass = 'level-INFO';
                    let logContent = '';

                    if (typeof log === 'object') {
                        // ê°ì²´ë¡œ ë°˜í™˜ëœ ê²½ìš°
                        const level = log.level || 'INFO';
                        if (level === 'ERROR' || level === 'CRITICAL') levelClass = 'level-ERROR';
                        else if (level === 'WARNING') levelClass = 'level-WARNING';
                        else if (level === 'DEBUG') levelClass = 'level-DEBUG';

                        logContent = log.full || `[${log.timestamp}] [${level}] ${log.message}`;
                    } else {
                        // ë¬¸ìì—´ë¡œ ë°˜í™˜ëœ ê²½ìš° (êµ¬ë²„ì „ í˜¸í™˜)
                        logContent = log;
                        if (log.includes('ERROR') || log.includes('CRITICAL')) levelClass = 'level-ERROR';
                        else if (log.includes('WARNING')) levelClass = 'level-WARNING';
                        else if (log.includes('DEBUG')) levelClass = 'level-DEBUG';
                    }

                    div.innerHTML = `
                        <span class="${levelClass}">${logContent}</span>
                    `;
                    logViewer.appendChild(div);
                });

                // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
                // logViewer.scrollTop = logViewer.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('log-viewer').innerHTML =
                    '<div style="text-align:center; padding:2rem; color:#ef4444;">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
    }

    function clearLogs() {
        if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        fetch('/api/logs/clear', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                refreshLogs();
            })
            .catch(error => console.error('Error:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        refreshLogs();
        // 5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
        setInterval(refreshLogs, 5000);
    });
</script>
{% endblock %}